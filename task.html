<!DOCTYPE html>

<head>
   <title>iptvbeat.com - Task </title>
   <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
   <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />   
   <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" ></script>   
   <script type="text/javascript" src="js/hc3.js"></script> 
   <script src="/socket.io/socket.io.js"></script> 
   <!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
	<!-- Optional theme
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
	 -->
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
   <script type="text/javascript">
   chart_option={		
		CreateOption:function(render, chart_type){	
			Highcharts.setOptions({
					global: {
						useUTC: true,
						colors: colors
					}
			});
			return options = {
				chart:{
					renderTo:render,
					type:chart_type,
					events: {
			            load: initiateComments()
		        	},
				},
				title: false,
				yAxis: {	
					title: {
						text: ''
					},
					startOnTick: false,	
					gridLineColor: '#eeeeee',
					gridLineDashStyle: 'dash',
					tickWidth:0,
					plotLines: [{
						value: 0,
						width: 0.5,
						color: '#dcdcdc'
					}],							
				},
				tooltip: {
					headerFormat: '<span style="font-size:12px">{point.key}</span><table>',
					pointFormat: '<tr><td style="color:{series.color};font-size:10px;padding:0">Rating:</td>' +
						'<td style="padding:0;font-size:10px;white-space:nowrap;"><b>{point.y:.1f} %</b></td></tr>',
					footerFormat: '</table>',
					shared: true,
					useHTML: true,
					enabled: true
				},
				
				plotOptions: {							
					column: {
						stacking: 'normal',
						borderWidth:1,
						pointPadding:0.001,
						groupPadding:0.2,		
					},	
					point: {
						events: {
							legendItemClick: function () {
								return false; // <== returning false will cancel the default action
							}
						},
						color: '#4572a7'
					},											
					series:{								
							series:{shadow:false},
							dataGrouping: {
								enabled: false
							},
							animation: false,
							dataLabels: {
				                    enabled: true,
				                    inside: false,
				                    align: 'right',
				                    useHTML: true,
				                    format: '<a href="#" class="comments">comments <span class="label label-default"></span></a>'
				            },
						}
					},					  
				exporting: {
					enabled: false
				},
				series: [{
					name: '',
					data: [],
					dataGrouping: {
						enabled: false
					}					
				}]
			};
		} 
	}
	var charts=[];
	var colors = ['#33b5e5', '#ff4444', '#ffbb33', '#99cc00', '#aa66cc', '#64E572', '#FF9655', '#FFF263', '#6AF9C4', '#2f7ed8', '#0d233a', '#8bbc21', '#910000', '#1aadce', '#492970', '#f28f43', '#77a1e5', '#c42525', '#a6c96a','#ddd'];
	$(function(){			
			//column chart
			charts["column_chart"] = new Highcharts.Chart(chart_option.CreateOption('column_chart', "column"));
			while (charts["column_chart"].series.length > 0)  charts["column_chart"].series[0].remove(true)	;
			charts["column_chart"].xAxis[0].setCategories(['POPTV','AKANAL','PLANETTV','TV3','POPKINO']);	
			var data=[{y:12.4,color:colors[0]}, {y:3.4,color:colors[1]}, {y:5.5,color:colors[2]},{y:1.5,color:colors[3]},{y:2.1,color:colors[4]}];
			series = {name: "Vievers", data:data ,showInLegend: false, shadow:false};			
			charts["column_chart"].addSeries(series);				
	});

	//update comments
	var socket = io.connect('http://localhost:8080');
	socket.on('comments', function (data) {
	 	// console.log(data);
	  	//socket.emit('my other event', { my: 'data' });
	  	$(data).each(function(i, el) {
	  		total = $(".highcharts-data-labels > div:eq("+el.category_id+") a.comments span.label").html();
	  		$(".highcharts-data-labels > div:eq("+el.category_id+") a.comments span.label").text(el.total);
	  		//notify user about new comment
	  		if(total != "" && total != el.total) 
	  			$(".highcharts-data-labels > div:eq("+el.category_id+") a.comments span.label").removeClass("label-default").addClass("label-success");
	  		var comments = "";
	  		$(el.comments).each(function(i, el) {
	  			comments += '<a href="#" class="list-group-item"><h6 class="list-group-item-heading">'+el.mail+'</h6><span class="time">@'+el.time+'</span><p class="list-group-item-text">'+el.comment+'</p></a>'
	  		})

	  		$(".highcharts-tracker rect:eq("+el.category_id+")").attr('data-content', '<div class="list-group"><div class="scroll">'+comments+'</div><div class="list-group-item" style="border: 0;padding-bottom:0;"><form><input class="form-control" type="text" placeholder="comment.."/><button type="button" onclick="closePopover()" class="btn btn-default closePopover" style="margin-top:4px;">Close</button><button type="button" class="btn btn-primary pull-right" data-toggle="button" style="margin-top:4px">Save</button></form></div>');

	  	})
	});

	function initiateComments() {
		$(document).ready(function() {
			$(".highcharts-tracker rect").hover(function() {
	         
	        }).popover({trigger:'manual', placement:'auto', html: true}).on('press', function() {
	        	$(".highcharts-tracker rect").not(this).popover('hide');
	        	$(this).popover('show');
	        	$('.popover').appendTo($(document.body));
	        	$("div.scroll").scrollTop($("div.scroll")[0].scrollHeight);
	        	//clear notification
	        	i = $(this).index();
	        	$(".highcharts-data-labels > div:eq("+i+") a.comments span.label").addClass("label-default").removeClass("label-success");
	        }).on('shown.bs.popover', function () {
  				$('div.arrow').remove();
			}).each(function(i, el) {
	        	$(el).attr('data-content', '<div class="list-group"><div class="scroll"></div><div class="list-group-item" style="border: 0;padding-bottom:0;"><form><input class="form-control" type="text" placeholder="comment.."/><button type="button" onclick="closePopover()" class="btn btn-default closePopover" style="margin-top:4px;">Close</button><button type="button" class="btn btn-primary pull-right" data-toggle="button" style="margin-top:4px">Save</button></form></div>');
	        });
			//show tooltip with comments
	        $('a.comments').on('click', function() {
				i = $(this).parent().parent().index();
				$(".highcharts-tracker rect:eq("+i+")").trigger('press');
			})	
		});			
	}

	function closePopover() {
		$(".highcharts-tracker rect").popover('hide');
	}

   </script>
   <style type="text/css">
		 body{font-family:arial;font-size:11px;margin:0px;padding:0px;}
		.chart{width:100%; margin:10px 0;height:480px;}
		.clear{clear: both;}
		.collab_users{width:100%; padding:5px 10px;background-color:#ddd;float:left;}
		.color_box {width:14px;height: 14px;margin-right: 5px;float:left}
		.header {background-color: #2b2b2b;border: none;z-index: 2000;height: 60px;width: 100%;box-shadow: 0px 0px 10px rgba(0,0,0,0.5);}
	
		.popover.top {
			margin-top: -14px;
		}

		.popover-content {
			padding: 0;
		}

		.scroll {
			max-height: 250px;
			overflow-y: auto; 
		}

		.list-group {
			margin-bottom: 10px;
		}

		.list-group-item {
			border-left: 0;
			border-right: 0;
		}
		.list-group-item-heading {
			margin-bottom: 0;
		}
		.list-group-item-text {
			margin-top: 5px;
		}

		span.time {
			font-size:10px;
		}

   </style>   
</head>
<body>
	<div>
		<div class="header">
			<a class="logo"></a>
		</div>
		<div class="clear"></div> 	
		<div style="padding:0px 20px 15px 0px;position:relative">	
			<div class="collab_users">
				<div class="legend_user"><div class="color_box" style="background-color:#5E4FA2;"></div><span>User 1</span></div>
			</div>
			<div class="clear"></div> 	
			<div class="chart" id="column_chart"></div>				
			<div class="clear"></div> 		
		</div>
	</div>
</body>